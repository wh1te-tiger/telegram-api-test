<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes, viewport-fit=cover">
    <title>Unity Web Player | telegram-api-test (Telegram)</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="TemplateData/style.css">
  </head>
  <body>
    <canvas id="unity-canvas" width=360 height=640 tabindex="-1" style="background: #231F20"></canvas>
    <div id="tg-loading">
      <div id="tg-loading-title">Loading Unity… <span id="tg-loading-pct">0%</span></div>
      <div id="tg-loading-bar"><div id="tg-loading-bar-fill"></div></div>
      <pre id="tg-loading-log"></pre>
    </div>

    <script src="Build/docs.loader.js"></script>
    <script>
      const loadingRoot = document.getElementById("tg-loading");
      const loadingPct = document.getElementById("tg-loading-pct");
      const loadingBarFill = document.getElementById("tg-loading-bar-fill");
      const loadingLog = document.getElementById("tg-loading-log");

      function logLine(line) {
        try {
          const ts = new Date().toISOString();
          loadingLog.textContent += `[${ts}] ${line}\n`;
          loadingLog.scrollTop = loadingLog.scrollHeight;
        } catch (_) { }
      }

      (function hookConsole() {
        const original = {
          log: console.log.bind(console),
          warn: console.warn.bind(console),
          error: console.error.bind(console),
        };

        function fmt(args) {
          return args.map(a => {
            try {
              if (a instanceof Error) return a.stack || a.message || String(a);
              if (typeof a === "object") return JSON.stringify(a);
              return String(a);
            } catch (_) {
              return String(a);
            }
          }).join(" ");
        }

        console.log = (...args) => { original.log(...args); logLine(`console.log: ${fmt(args)}`); };
        console.warn = (...args) => { original.warn(...args); logLine(`console.warn: ${fmt(args)}`); };
        console.error = (...args) => { original.error(...args); logLine(`console.error: ${fmt(args)}`); };
      })();

      window.addEventListener("error", (e) => logLine(`window.error: ${e.message || e}`));
      window.addEventListener("unhandledrejection", (e) => logLine(`unhandledrejection: ${e.reason || e}`));
      logLine(`url: ${location.href}`);
      logLine(`ua: ${navigator.userAgent}`);

      try {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
        }
      } catch (e) { }

      var canvas = document.querySelector("#unity-canvas");
      function telegramResize() {
        canvas.style.width = "100%";
        canvas.style.height = "100%";
        canvas.style.position = "fixed";
        canvas.style.top = "0";
        canvas.style.left = "0";
      }
      telegramResize();
      window.addEventListener("resize", telegramResize);

      if (typeof createUnityInstance !== "function") {
        logLine("Unity loader did not define createUnityInstance(). Check that Build/*.loader.js is reachable.");
        throw new Error("createUnityInstance is not available");
      }

      logLine("Starting Unity loader…");
      createUnityInstance(canvas, {
        arguments: [],
        dataUrl: "Build/docs.data",
        frameworkUrl: "Build/docs.framework.js",
        codeUrl: "Build/docs.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "telegram-api-test",
        productVersion: "1.0",
        showBanner: (msg, type) => logLine(`banner(${type || "info"}): ${msg}`),
      }, (progress) => {
        const pct = Math.max(0, Math.min(1, progress || 0));
        loadingPct.textContent = `${Math.round(pct * 100)}%`;
        loadingBarFill.style.width = `${pct * 100}%`;
      }).then(() => {
        logLine("Unity started.");
        loadingRoot.classList.add("hidden");
      }).catch((message) => {
        logLine(`Unity failed: ${message}`);
      });
    </script>
  </body>
</html>
